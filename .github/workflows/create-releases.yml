name: Create Releases
on:
    workflow_dispatch:
jobs:
    create-prerelease:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download all artifacts
              uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: publish-aot.yml
                  workflow_conclusion: success
            - name: Unzip and rename artifacts
              run: |
                  ls -lRa
                  mkdir unzipped
                  for dir in artifacts/*-build; do
                      platform=$(basename "$dir" -build)
                      unzip -j "$dir" -d "unzipped/$platform"
                      for file in unzipped/$platform/*; do
                      if [[ -f "$file" ]]; then
                          extension="${file##*.}"
                          new_name="${platform}-SharpTree.${extension}"
                          mv "$file" "unzipped/$platform/$new_name"
                      fi
                      done
                  done
                  ls -lRa unzipped
            - name: Create prerelease
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  tag_name="v$(date +'%Y.%m.%d-%H%M')"
                  gh release create $tag_name \
                      --title "Prerelease $tag_name" \
                      --notes "Auto-generated prerelease for commit ${{ github.sha }}" \
                      --prerelease \
                      unzipped/*/*
